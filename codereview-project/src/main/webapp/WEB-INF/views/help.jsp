<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ page contentType="text/html;charset=UTF-8" %>
<c:set var="pageTitle" value="Помощь: как работает код-ревью" />
<jsp:include page="/WEB-INF/views/includes/header.jsp" />

<div class="page-header">
    <div>
        <h1 class="page-title">Помощь: как работает код-ревью</h1>
        <p class="page-subtitle">
            Полный цикл работы: от загрузки проекта до merge и скачивания обновлённой версии
        </p>
    </div>
</div>

<div class="help-content">

    <h2>1. Проекты и файлы</h2>
    <p>
        Всё начинается с <strong>проекта</strong>. Проект — это набор файлов, которые
        считаются «каноничной» версией кода (аналог master-ветки в Git).
    </p>
    <ol>
        <li>Создайте проект на странице «Новый проект».</li>
        <li>Загрузите в него файлы (через интерфейс файлов проекта).</li>
        <li>Эти файлы попадают в хранилище проекта и будут использоваться как база для будущих код-ревью и патчсетов.</li>
    </ol>
    
    <h3>Быстрая загрузка проекта через скрипт</h3>
    <p>
        Чтобы быстро загрузить все файлы проекта одним архивом, используйте скрипт:
    </p>
    <ol>
        <li>
            <a href="${pageContext.request.contextPath}/resources/crp-upload.sh" download>Скачайте скрипт crp-upload.sh</a> 
            и поместите его в корень вашего проекта.
        </li>
        <li>
            Выполните команду:
            <pre style="background: #1e1e1e; color: #f5f5f5; padding: 8px; border-radius: 4px; font-size: 12px;"><code>sh crp-upload.sh my-project.zip</code></pre>
        </li>
        <li>
            Скрипт упакует все файлы проекта в ZIP-архив:
            <ul style="margin: 4px 0; font-size: 13px;">
                <li>Если это <strong>git-репозиторий</strong> — уважает <code>.gitignore</code></li>
                <li>Если git отсутствует — упаковывает всё рекурсивно (исключая <code>.git</code>, <code>node_modules</code>, <code>target</code>, <code>build</code>, и др.)</li>
            </ul>
        </li>
        <li>
            Зайдите на страницу проекта и используйте форму «Быстрый импорт из ZIP-архива» 
            для загрузки всех файлов одним кликом.
        </li>
    </ol>
    <p class="help-hint">
        Скрипт работает и с git-проектами, и с обычными папками с кодом.
    </p>

    <hr/>

    <h2>2. Создание код-ревью</h2>
    <p>
        Когда вы хотите внести изменения в проект, вы создаёте <strong>код-ревью</strong>.
        Это отдельная «ветка обсуждения» вокруг конкретного набора изменений.
    </p>
    <ol>
        <li>Откройте проект и нажмите «Создать код-ревью».</li>
        <li>Укажите заголовок и описание — объясните, какие изменения вы планируете и зачем.</li>
        <li>Выберите файлы, с которыми будете работать (новые или уже существующие в проекте).</li>
    </ol>
    <p>
        После создания ревью оно находится в статусе <strong>WIP (черновик)</strong>:
        только вы видите изменения, можно свободно редактировать файлы первой ревизии.
    </p>

    <hr/>

    <h2>3. Статусы ревью: от черновика до merge</h2>
    <p>У ревью есть несколько основных статусов:</p>
    <ul>
        <li><strong>WIP</strong> — черновик, можно редактировать код.</li>
        <li><strong>ACTIVE</strong> — ревью открыто для просмотра и комментариев.</li>
        <li><strong>CHANGES_REQUIRED</strong> — ревьюеры попросили внести правки.</li>
        <li><strong>APPROVED</strong> — все ревьюеры одобрили изменения.</li>
        <li><strong>CLOSED</strong> — изменения замержены в проект.</li>
        <li><strong>ABANDONED</strong> — ревью отменено.</li>
    </ul>
    <p>
        Пока ревью в <strong>WIP</strong>, вы можете менять файлы текущей ревизии.
        Как только вы нажимаете «Открыть ревью» (статус <strong>ACTIVE</strong>),
        эта ревизия <strong>блокируется от правок</strong>.
    </p>

    <hr/>

    <h2>4. Патчсеты (ревизии)</h2>
    <p>
        <strong>Патчсет</strong> — это ревизия набора файлов в рамках одного ревью.
        Первая ревизия создаётся автоматически при создании ревью.
    </p>
    <p>Как только ревью становится ACTIVE:</p>
    <ul>
        <li>Файлы текущей ревизии нельзя больше редактировать напрямую — это зафиксированное состояние кода, которое видят ревьюеры.</li>
    </ul>
    <p>Чтобы внести правки после комментариев:</p>
    <ol>
        <li>Нажмите кнопку <strong>«Новая ревизия (Patchset)»</strong>.</li>
        <li>Система создаст копию файлов из последней ревизии — это будет новая ревизия с увеличенным номером.</li>
        <li>Теперь вы редактируете именно новую ревизию.</li>
    </ol>
    <p>
        История патчсетов не теряется: можно просматривать старые ревизии и сравнивать их друг с другом или с исходными файлами проекта.
        Комментарии к старым ревизиям помечаются как <strong>outdated</strong>.
    </p>

    <hr/>

    <h2>5. Ревьюеры и участники обсуждения</h2>
    <p>Для ревью можно назначить только <strong>ревьюеров</strong>:</p>
    <ul>
        <li><strong>REVIEWER</strong> — смотрит код, комментирует и голосует.</li>
    </ul>
    <p>Только назначенные ревьюеры могут выставлять итоговые оценки ревью.</p>

    <hr/>

    <h2>6. Комментарии и обсуждение</h2>
    <p>В ревью доступны несколько видов комментариев:</p>
    <ul>
        <li><strong>Общий комментарий</strong> — к ревью в целом.</li>
        <li><strong>Комментарий к файлу</strong> — к конкретному файлу.</li>
        <li><strong>Комментарий к строке</strong> — inline-комментарий прямо в diff.</li>
    </ul>
    <p>Комментарии группируются в треды (цепочки ответов), которые можно <strong>разрешать</strong> (resolve) и при необходимости <strong>открывать снова</strong>.</p>
    <p>На странице ревью есть навигация по нерешённым комментариям и индикаторы комментариев на полях с номерами строк.</p>

    <hr/>

    <h2>7. Оценки (голоса) ревьюеров</h2>
    <p>После того как ревьюеры посмотрели код и оставили комментарии, они могут выставить оценку ревью:</p>
    <ul>
        <li><strong>+1</strong> — изменения одобрены;</li>
        <li><strong>-1</strong> — требуется доработка (CHANGES_REQUIRED).</li>
    </ul>
    <p>Правила для merge:</p>
    <ul>
        <li>Все назначенные ревьюеры должны поставить <strong>+1</strong>.</li>
        <li>У ревью не должно быть незакрытых (нерешённых) комментариев.</li>
        <li>Рассматривается последняя ревизия (последний патчсет).</li>
    </ul>
    <p>
        Логика простая: если кто-то из ревьюеров поставил отрицательную оценку или оставил
        незакрытые замечания — ревью нельзя замержить, пока автор не создаст новый патчсет
        и не исправит код.
    </p>

    <hr/>

    <h2>8. Merge: применение изменений в проект</h2>
    <p>
        Когда все ревьюеры одобрили последнюю ревизию и комментарии закрыты,
        ревью переходит в статус <strong>APPROVED</strong>, и становится доступен merge.
    </p>
    <ol>
        <li>Пользователь с правами (автор ревью, владелец проекта или администратор) нажимает кнопку <strong>«Merge»</strong>.</li>
        <li>Система применяет изменения из последнего патчсета к файлам проекта (обновляет, добавляет или удаляет файлы).</li>
        <li>Операция выполняется атомарно: либо все изменения применены, либо ни одно.</li>
        <li>Статус ревью меняется на <strong>CLOSED</strong>, код в проекте обновлён.</li>
    </ol>

    <hr/>

    <h2>9. Скачивание обновлённого проекта</h2>
    <p>
        После merge (или в любой момент) вы можете скачать текущую версию проекта:
    </p>
    <ol>
        <li>Откройте страницу проекта.</li>
        <li>Нажмите кнопку <strong>«Скачать проект»</strong>.</li>
        <li>Система сформирует ZIP-архив на основе актуальных файлов проекта (с учётом всех замерженных ревью).</li>
    </ol>
    <p>
        Таким образом, типичный цикл работы выглядит так:
    </p>
    <ol>
        <li>Создать проект и загрузить исходный код.</li>
        <li>Создать код-ревью и подготовить изменения (черновик WIP).</li>
        <li>Открыть ревью (ACTIVE) и пригласить ревьюеров.</li>
        <li>Получить комментарии, исправить код через новые патчсеты.</li>
        <li>Собрать все <strong>+1</strong> от ревьюеров и закрыть все треды.</li>
        <li>Замержить изменения в проект (CLOSED).</li>
        <li>Скачать обновлённый проект при необходимости.</li>
    </ol>
    <p>
        Если вы новичок: начните с создания небольшого тестового проекта и пройдите
        этот путь один раз целиком — так проще всего почувствовать, как работает система.
    </p>
</div>

<jsp:include page="/WEB-INF/views/includes/footer.jsp" />

